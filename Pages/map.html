<!DOCTYPE html>
<html>
<head>
  <title>Pemetaan Gereja</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="image/images.jpg" type="image/png">

  <link rel="stylesheet" href="styling navbar/navbar.css" />
  <link rel="stylesheet" href="styling content/content.css" />
  <link rel="stylesheet" href="styling content/contentmap.css" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
</head>

<body>
  <h2>Find Your Church!</h2>

  <div id="search-container">
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Cari nama gereja..." autocomplete="off" aria-label="Cari gereja" />
      <button id="search-btn" aria-label="Cari">Cari</button>
    </div>
  </div>
      <!-- Removed suggestions dropdown -->

  <main class="map-page-content" style="padding:20px;">
    <div id="map"></div>
    <aside id="sidebar" aria-hidden="true">
      <button id="close-sidebar" aria-label="Tutup">×</button>
      <div id="sidebar-content"></div>
    </aside>
  </main>
  <style>
  #map{ width:100%; height:70vh; max-width:1200px; margin:0 auto; border-radius:8px; border:1px solid #ddd; z-index:1 }
  .map-page-content{ overflow: visible }
  /* global sidebar style: left-positioned with improved appearance */
  #global-sidebar{ position:fixed !important; left:0 !important; top:84px !important; width:360px !important; max-width:92vw !important; height:calc(100vh - 100px) !important; background:#fff !important; box-shadow:8px 0 24px rgba(0,0,0,0.12) !important; padding:16px !important; box-sizing:border-box !important; transform:translateX(-110%) !important; transition:transform .28s ease !important; z-index:400000 !important; overflow:auto !important; display:none !important; border-radius:0 8px 8px 0 !important }
  #global-sidebar.open{ transform:translateX(0) !important; display:block !important }
  @media(max-width:900px){ #global-sidebar{ top:72px; width:100%; height:45vh; transform:translateY(110%); left:0; right:0 } #global-sidebar.open{ transform:translateY(0) } }
  #search-container{ max-width:1200px; margin:12px auto; padding:0 20px; position:relative }
  .search-box{ display:flex; gap:8px; align-items:center }
  #search-container input{ flex:1; padding:10px 12px; border:1px solid #ccc; border-radius:6px; font-size:15px }
  #search-container button{ padding:10px 14px; border:none; background:#1976d2; color:#fff; border-radius:6px; cursor:pointer; font-weight:600 }
  #search-container button:hover{ background:#155fa0 }
  /* suggestions dropdown */
  #search-suggestions{ list-style:none; margin:8px 0 0 0; padding:6px; position:absolute; left:20px; right:20px; top:62px; background:#fff; border:1px solid #e6e6e6; border-radius:8px; max-height:260px; overflow:auto; box-shadow:0 6px 20px rgba(0,0,0,0.08); z-index:9998 }
  #search-suggestions li{ padding:8px; border-radius:6px; cursor:pointer }
  #search-suggestions li[aria-selected="true"], #search-suggestions li:hover{ background:#f1f5fb }
    /* sidebar */

      /* style the original #sidebar to appear from the LEFT and look nicer
         - moved a bit inward and made slightly shorter on desktop so it
           doesn't overlap the search bar */
  /* shorter and lower so it doesn't overlap the search bar
     with fade animation (opacity) on open/close */
  #sidebar{ position:fixed; left:300px; top:250px; width:320px; max-width:92vw; height:calc(90vh - 200px); background:#fff; box-shadow:8px 0 24px rgba(0,0,0,0.12); padding:18px; box-sizing:border-box; transform:translateX(-110%); opacity:0; transition:transform .28s ease, opacity .28s ease; z-index:200000; overflow:auto; border-radius:0 10px 10px 0 }
    #sidebar.open{ transform:translateX(0); opacity:1 }
    /* small rounded close button in header */
    #close-sidebar{ position:absolute; right:12px; top:12px; border:none; background:rgba(0,0,0,0.06); width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:50%; font-size:18px; cursor:pointer; color:#222 }
    #close-sidebar:hover{ background:rgba(0,0,0,0.12) }
    /* sidebar content styles */
    #sidebar img{ width:100%; height:170px; object-fit:cover; border-radius:6px; display:block; margin-bottom:12px }
    #sidebar h3{ margin:8px 0 6px 0; font-size:18px }
    #sidebar p{ margin:6px 0; color:#222; line-height:1.35 }
    @media(max-width:900px){ #sidebar{ top:72px; width:100%; height:45vh; transform:translateY(110%); left:0; right:0 } #sidebar.open{ transform:translateY(0) } }
  </style>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>

    function showMapError(msg){
      const mapEl = document.getElementById('map');
      mapEl.innerHTML = `<div style="padding:20px;color:#900;background:#fff6f6;border-radius:8px;border:1px solid #f2c2c2;">${msg}</div>`;
      console.error('Map error:', msg);
    }

    function initMap(){
      if(typeof L === 'undefined'){
        showMapError('Leaflet library tidak ditemukan. Pastikan koneksi internet atau file Leaflet dimuat.');
        return;
      }
      const mapEl = document.getElementById('map');
      let map;
      try{
        map = L.map(mapEl).setView([-0.895,119.868],13);
      }catch(err){
        showMapError('Gagal menginisialisasi peta: '+ err.message);
        console.error(err);
        return;
      }
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

      // quick guard: ensure churches array exists so code below doesn't fail silently
      if(!Array.isArray(churches) || churches.length===0){
        console.warn('No churches data available to render markers');
      }
      const markers = {};
      // pre-create global sidebar so it exists in the DOM (prevents race conditions)
      try{ getGlobalSidebar(); }catch(e){ console.warn('pre-create global sidebar failed', e); }
      (Array.isArray(churches) ? churches : []).forEach(ch => {
        const marker = L.marker([ch.lat,ch.lng]).addTo(map);
        const popupHtml = `<div style="min-width:180px"><strong>${ch.name}</strong><br><small>${ch.street}</small><br><a href="#">Lihat detail</a></div>`;
        marker.bindPopup(popupHtml);
        marker.on('mouseover', function(){ this.openPopup(); });
        marker.on('mouseout', function(){ this.closePopup(); });
        marker.on('click', function(){ try{ if(window.openSidebar) return window.openSidebar(ch); return openSidebar(ch); }catch(e){ console.warn('marker click -> openSidebar failed', e); } });
        markers[ch.id]=marker;
      });

  // resize fix
      setTimeout(()=>map.invalidateSize(),300);
      window.addEventListener('resize', ()=> setTimeout(()=>map.invalidateSize(),200));

      // simple search: find first match on Enter or button click
      const input = document.getElementById('search-input');
      const searchBtn = document.getElementById('search-btn');
      function simpleSearch(){ const q = input.value.trim().toLowerCase(); if(!q) return; const found = churches.find(c => c.name.toLowerCase().includes(q) || c.street.toLowerCase().includes(q)); if(found){ const m = markers[found.id]; if(m){ map.setView(m.getLatLng(),16,{animate:true}); m.openPopup(); } else if(found.lat && found.lng){ map.setView([found.lat, found.lng],16,{animate:true}); } openSidebar(found); } }
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); simpleSearch(); } });
      if(searchBtn) searchBtn.addEventListener('click', ()=>{ simpleSearch(); input.focus(); });

      // sidebar: use a global body-attached sidebar to avoid clipping by map containers
      const localSidebar = document.getElementById('sidebar');

      function getGlobalSidebar(){
        let g = document.getElementById('global-sidebar');
        if (g) return g;
        // clone structure into a body-level sidebar
        g = document.createElement('aside');
        g.id = 'global-sidebar';
        g.setAttribute('aria-hidden','true');
  // rely on CSS rules added to the page for layout; keep inline display off by default
  g.style.display = 'none';
        // close button
        const btn = document.createElement('button');
        btn.id = 'global-close-sidebar';
        btn.setAttribute('aria-label','Tutup');
        btn.textContent = '×';
        btn.style.position = 'absolute';
        btn.style.left = '8px';
        btn.style.top = '8px';
        btn.style.border = 'none';
        btn.style.background = 'transparent';
        btn.style.fontSize = '22px';
        btn.style.cursor = 'pointer';
        g.appendChild(btn);
        const content = document.createElement('div');
        content.id = 'global-sidebar-content';
        g.appendChild(content);
        document.body.appendChild(g);
        btn.addEventListener('click', ()=>{ closeSidebar(); });
        return g;
      }
      // expose helper globally so SPA/injected contexts can call it
      try{ window.getGlobalSidebar = getGlobalSidebar; }catch(e){}

      function openSidebar(ch){
        const s = document.getElementById('sidebar');
        const content = document.getElementById('sidebar-content');
        // populate
        content.innerHTML = `<img src="${ch.foto || ''}" onerror="this.onerror=null;this.src='image/Gereja.png'" alt="${ch.name}"><h3>${ch.name}</h3><p>${ch.schedule || ch.jadwal || ''}</p><p><b>Alamat:</b> ${ch.street || ch.alamat || '-'}</p>`;
        // show
        try{ s.style.display='block'; s.classList.add('open'); s.setAttribute('aria-hidden','false'); s.style.zIndex='200001'; }catch(e){ console.warn('openSidebar local failed', e); }
        console.log('openSidebar called for', ch.name);
      }
  // expose openSidebar globally as well (defensive for SPA scope issues)
  try{ window.openSidebar = openSidebar; }catch(e){}

      function closeSidebar(){
        const g = document.getElementById('global-sidebar');
        if (g){ g.classList.remove('open'); g.setAttribute('aria-hidden','true'); setTimeout(()=>{ try{ g.style.display='none'; }catch(e){} }, 320); }
        try{ localSidebar.classList.remove('open'); localSidebar.setAttribute('aria-hidden','true'); localSidebar.style.display='none'; }catch(e){}
      }

      document.getElementById('close-sidebar').addEventListener('click', closeSidebar);

      // --- TEMPORARY TESTS (remove later) ---
      // 1) briefly show a demo using the local #sidebar so desktop users see it
      try{
        const demoEl = document.getElementById('sidebar');
        const demoContent = document.getElementById('sidebar-content');
        if(demoContent){ demoContent.innerHTML = `<h3>Demo Sidebar</h3><p>Jika Anda melihat ini, sidebar dapat muncul di desktop.</p>`; }
        demoEl.style.display = 'block'; demoEl.classList.add('open'); demoEl.setAttribute('aria-hidden','false');
        setTimeout(()=>{ try{ demoEl.classList.remove('open'); demoEl.style.display='none'; }catch(e){} }, 2200);
      }catch(e){ console.warn('demo sidebar test failed', e); }

      // 2) simulate clicking the first marker (if any) to verify openSidebar works
      try{
        if(Array.isArray(churches) && churches.length>0){
          setTimeout(()=>{
            try{ openSidebar(churches[0]); }catch(e){ console.warn('simulated openSidebar failed', e); }
          }, 600);
        }
      }catch(e){ console.warn('simulate click test failed', e); }
      // --- end TEMPORARY TESTS ---
    }

    // Try to ensure Leaflet is available: if not, dynamically load CSS+JS with fallback
    function loadScript(src, cb){ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=cb; s.onerror=()=>cb(new Error('Failed to load '+src)); document.head.appendChild(s); }
    function loadCss(href){ const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; document.head.appendChild(l); }

    function ensureLeaflet(callback){
      if(typeof L !== 'undefined') return callback();
      // try primary CDN (already included above may fail) then fallback
      const cssUrls=['https://unpkg.com/leaflet@1.9.4/dist/leaflet.css','https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css'];
      const jsUrls=['https://unpkg.com/leaflet@1.9.4/dist/leaflet.js','https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'];
      // inject css first
      loadCss(cssUrls[0]);
      // try load first script, if fails try fallback
      loadScript(jsUrls[0], function(err){
        if(!err && typeof L !== 'undefined') return callback();
        console.warn('Primary Leaflet load failed, trying fallback');
        loadCss(cssUrls[1]);
        loadScript(jsUrls[1], function(err2){ if(err2 || typeof L === 'undefined') return callback(new Error('Unable to load Leaflet from CDNs')); return callback(); });
      });
    }

    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', ()=> ensureLeaflet((err)=>{ if(err){ console.error(err); document.getElementById('map').innerHTML='<div style="padding:16px;color:#900;background:#fff6f6;border:1px solid #f2c2c2;border-radius:8px;">Gagal memuat library peta. Periksa koneksi atau CDN.</div>'; } else initMap(); })); else ensureLeaflet((err)=>{ if(err){ console.error(err); document.getElementById('map').innerHTML='<div style="padding:16px;color:#900;background:#fff6f6;border:1px solid #f2c2c2;border-radius:8px;">Gagal memuat library peta. Periksa koneksi atau CDN.</div>'; } else initMap(); });
  </script>
</body>
</html>
